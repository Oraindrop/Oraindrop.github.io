---
layout: post
title:  "TIL(20190513)"
categories: TIL
author : choising
tags: til
---

# 20190513

## 자바 최적화 (~ 62p)

### 들어가며

- > 지금이 자바 개발자들에게 가장 흥분되는 시기 아닐까요? 지금처럼 자바 플랫폼으로 다재다능하고 응답성 좋은 애플리케이션을 구축할 기회가 많았던 적은 한번도 없었습니다. 건투를 빕니다!

### CHAPTER 1. 성능과 최적화

- 자바 초창기에는 메서드 디스패치 성능이 최악이었다
    - 메서드를 잘게 나누지 말고, 하나의 덩치 큰 메서드로 작성하는게 좋다고 권고하는 개발자가 있었다고 한다. 이 때는 성능 >>>>>>> 넘사 >>>> 가독성 이었을듯
    - 최근은 JVM이 넘나 좋아졌고, **자동 인라이닝(automatic managed inlining)** 덕분에 그런 문제가 없다고 한다
        - 자동 인라이닝이 뭐임?
        - 찾아보니 
        - > Inlining은 소형 메소드 트리가 해당 호출자 트리로 병합되거나 "인라인되는" 프로세스입니다. 이렇게 하면 자주 실행되는 메소드 호출의 속도가 향상됩니다. - 출처 [갓IBM](https://www.ibm.com/support/knowledgecenter/ko/SSYKE2_7.0.0/com.ibm.java.lnx.70.doc/diag/understanding/jit_optimize.html)
            - 위 글을 보면 JIT(just-in-time) 컴파일러가 컴파일 시 1번 과정이 inlining 이라고 한다
            - 이렇게 하면 메소드 여러번 호출 시 메소드 로직을 실제로 여러번 돌리는게 아니라 한 번 돌려서 나온 값을 바로 쓸 수 있게 되는 것이고 그러면 성능이 올라갈 것 같긴 하다고 이해했음

- 인터넷에서 찾은 글을 무턱대고 믿어선 안된다고 한다
    - 하지만 어쩔수 없는걸..

- 이런 이유로 이 책에서는 코드에 바로 써먹을 수 있는 성능 팁을 나열하진 않았다고 한다
    - 여러가지 단면을 종합 집중 조명하겠

#### 1.2 자바 성능 개요

- 자바는 실용적인 언어.
- **관리되는 서브시스템(managed subsystem)**, 개발자가 일일히 용량을 세세하게 관리하는 부담을 덜어주고, 대신 저수준으로 제어 가능한 일부 기능을 포기하자는 발상.
    - 예 ) GC

- JVM 애플리케이션의 성능 측정값은 정규분포를 따르지 않는 경우 가많다.
    - 샘플링 해버리면 특이점이 묻혀버릴 수 도

> 소프트웨어 산업의 가장 경이적인 성과는 하드웨어 산업에서 꾸준히 이루어낸 혁신을 끊임없이 무용지물로 만들고 있는 것이다. - 헨리 페트로스키
- ㅋㅋ 이거 개웃기고 팩트다. 하드웨어 싸고 성능 좋아서, 성능보다 갓독성을 중시하니깐

- 소프트웨어 성능을 정량적으로 측정할 수 없다. 즉 `성능`은 아래와 같은 활동을 하면서 원하는 결과를 얻기 위한, 일종의 `실험과학`이다.
    - 원하는 결과 정의
    - 기존 시스템 측정
    - 요건 충족하기 위해 무슨일을 해야할 지 정리
    - 개선활동 추진
    - 테스트
    - 목표 달성 ? 끝 : 다시

#### 1.4 성능 분류

- 가장 일반적인 기본 성능 지표
    - 처리율
        - 시스템이 수행 가능한 작업 비율
        - 일정 시간 동안 완료한 작업 단위수 (예 : TPS)
    - 지연
        - 하나의 트랜잭션을 처리하는데 소요된 시간
        - 종단 시간
    - 용량
        - 시스템이 동시 처리 가능한 작업 단위(트랜잭션) 개수
        - 딱 봐도 처리율과 밀접한 연관
    - 사용률
        - 사용 목적이나 리소스별로 들쑥날쑥할 수 있다
    - 효율
        - (처리율 / 리소스 사용률)
        - 가격으로 측정하는 방법도 있음
    - 확장성
        - 리소스 추가에 따른 처리율 변화로 확장성을 가늠할 수 있음
        - 클러스터를 2배로 늘려 트랜잭션 처리량도 2배 늘었다면 이 시스템은 *완벽한 선형 확장*
            - 현실적으로 이럴 수는 없음
    - 저하
        - 요청 개수 증가, 요청 접수 속도 증가 등 어떤 형태로든 시스템이 더 많은 부하를 받으면 지연 / 처리율 측정 값에 변화가 생긴다.
        - 사용율이 낮았으면 측정값이 느슨하게 변하고, 시스템이 풀 가동된 상태라면 처리율이 더는 늘지 않고 지연이 증가하는 양상. 이런 현상을 부하 증가에 따른 저하
    
- 실제로 어느 한 지표를 최적화 하면 다른 지표(들)가 악화되는 경우도 흔하다

### CHAPTER 2. JVM 이야기

#### 2.1 인터프리팅과 클래스로딩

- VM Spec : 자바 가상머신 규정 명세서
- JVM은 스택 기반의 해석 머신
    - 물리적 CPU 하드웨어인 레지스터는 없지만, 일부 결과를 실행 스택에 보관하며, 이 스택의 맨 위에 쌓인 값(들)을 가져와 계산한다

- JVM 인터프리터의 기본 로직 
    - 쉽게 말하자면, 평가 스택을 이용해 중간값들을 담아두고 가장 마지막에 실행된 명령어와 독립적으로 프로그램을 구성하는 opcode(명령어)를 하나 씩 순서대로 처리하는 `while 루프 안의 switch 문`

- 클래스 로딩
    - 부트스트랩 클래스가 자바 런타임 코어 클래스 로드
    - 확장 클래스 로더 생김, 부트스트랩 클래스로더가 자기 부모고, 필요할 때 클래스로딩 작업을 부모에게 넘긴다
    - 끝으로, 애플리케이션 클래스로더가 생성되고 지정된 클래스패스에 위치한 유저 클래스를 로드한다.

- 자바는 프로그램 실행 중 처음보는 새 클래스를 디펜던시에 로드.
    - 찾지 못한 클래스로더는 자신의 부모 클래스로더에게 룩업을 넘김
    - 결국 부투스트랩도 룩업하지 못하면 ClassNotFoundException 이 나게됨.

- 한 시스템에서 클래스는 패키지명을 포함한 풀 클래스 명과 자신을 로드한 클래스로더,  두 가지 정보로 식별된다.

#### 2.2 바이트 코드 실행

- 바이트 코드는 특정 컴퓨터 아키텍처에 특정하지 않은 `중간 표현형 (IR)` 
    - 컴퓨터 아키텍처의 지배 ㄴㄴ
    - 이식성 좋
    - 개발을 마치고 컴파일 된 소프트웨어

- 클래스 파일
    - 매직 넘버 : 0xCAFEBABE
    - 클래스 파일 포맷 버전 : 메이저/마이너 
    - 상수 풀 : 클래스 상수들이 모여 있는 위치
    - 액세스 플래그 : 추상 클래스, 스테틱 클래스 등 클래스 종류 표시
        - public 인지 final 인지, 인터페이스인지, 추상 클래스인지
    - this 클래스 : 현재 클래스
    - super 클래스 : 수퍼 클래스
    - 인터페이스 : 클래스가 구현한 모든 인터페이스
    - 필드 : 클래스에 들어 있는 필드
    - 메서드 : 클래스에 들어 있는 메서드
    - 속성 : 클래스가 지닌 모든 속성 (소스 파일명 등)

#### 2.3 핫스팟 입문

- JIT 컴파일
    - 바이트코드 -> 네이티브 코드로 컴파일

- 핫스팟은 인터프리티드 모드로 실행하는 동안 애플리케이션을 모니터링하면서 가장 자주 실행되는 코드 파트를 발견해 JIT 컴파일을 수행
    - 특정 메서드가 어느 한계치를 넘어가면 프로파일러가 특정 코드 섹션을 컴파일/최적화 한다

- 컴파일러가 해석 단계에서 수집한 추적 정보를 근거로 최적화를 결정한다는게 가장 큰 장점

#### 2.4 JVM 메모리 관리

- 자바는 Garbage Collection 이라는 프로세스를 이용해 힙 메모리를 자동 관리하는 방식
    - JVM이 더 많은 메모리를 할당해야 할 때 불필요한 메모리를 회수하거나 재사용하는 불확정적(nondeterministic) 프로세스

- Stop The World

#### 2.6 JVM 구현체 종류

- OpenJDK : 오픈소스, 오라클이 직접 프로젝트를 주관/지원
- 오라클Java
- Zulu(줄루) : 유료 지원 서비스 가능
- 아이스티(IcedTea) : 레드햇
- J9 : IBM

#### 2.7 JVM 모니터링과 툴링

- Java Management Extensions(JMX) : 자바 관리 확장
    - JVM과 그 위에서 동작하는 애플리케이션을 제어하고 모니터링하는 강력한 범용 툴

- 자바 에이전트
    - 자바 언어로 작성된 툴 컴포넌트로, java.lang.instrument 인터페이스로 메서드 바이트코드를 조작