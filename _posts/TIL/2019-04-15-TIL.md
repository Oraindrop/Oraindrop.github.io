---
layout: post
title:  "TIL(20190415)"
categories: TIL
author : choising
tags: til
---

# 20190415

## SQL 레벨업 ( ~ 47P)

### 3강 DBMS와 실행 계획

- DBMS의 쿼리 처리 흐름

    ![DBMS_Query_flow](https://github.com/Oraindrop/oraindrop.github.io/blob/master/assets/_img/QueryFlow.png?raw=true)

- Parser(파서)
    - 구문 분석 역할

- Optimizer(옵티마이저)
    - 한국 번역은 `최적화`
    - 최적화의 대상이 `실행 계획`, DBMS 두뇌의 핵심
    - 플랜 생성
        - 인덱스 유무, 데이터 분산/편향 정도, DBMS 내부 매개변수 등 조건을 고려하여 선택 가능한 많은 실행계획 작성
    - 비용 평가
        - 이들의 비용을 연산
    - 가장 낮은 비용의 실행계획을 택한다

- Catalog Manager(카탈로그 매니저)
    - 옵티마이저가 실행 계획을 세울 때 옵티마이저에 중요한 정보를 제공하는 역할
    - 카탈로그
        - DBMS 내부 정보를 모아놓은 테이블
        - 테이블, 인덱스의 통계 정보가 저장
        - 카탈로그 정보를 `통계 정보` 라고 부르기도 한다

- Plan Evaluation(플랜 평가)
    - 최적의 실행결과를 선택하는 것

#### 옵티마이저와 통계 정보

- 플랜 선택을 옵티마이저에게 맡기는 경우, 실제로 최적의 플랜이 선택되지 않는 경우가 꽤 많다

- 대표적인 원인으로 통계정보가 부족한 경우

- 카탈로그에 포함되어 있는 통계정보는 아래와 같은 것들
    - 각 테이블의 레코드 수
    - 각 테이블의 필드 수와 필드의 크기
    - 필드의 cardinality (값의 개수)
    - 필드 값의 히스토그램 (분포정도)
    - 필드 내부에 있는 Null 수
    - 인덱스 정보

- 문제가 생기는 경우는 이러한 카탈로그 정보가 테이블 또는 인덱스의 실제와 일치하지 않을 때
    - 테이블에 데이터 삽입/갱신/제거 시 카탈로그 정보가 갱신되지 않는다면
    - 옵티마이저는 오래된 정보를 바탕으로 실행 계획을 세우게 된다

#### 최적의 실행 계획이 작성되게 하려면

- 위처럼, 올바른 통계 정보가 모이는 것은 SQL 성능에 있어서 굉장히 중요한 문제

- 수동으로 갱신하는 것 뿐 아니라 DBMS 에 따라 갱신 전략에 차이가 있다.
    - ex) Oracle 기본설정에서 정기적으로 통계 정보 갱신 Job 수행, MS SQL 갱신 처리가 수행되는 시점에 자동으로 통계 정보 갱신

- 통계 정보 갱신은 실행 비용이 굉장히 높은 작업
    - 하지만 DBMS가 최적의 플랜을 선택하려면 꼭 필요한 조건이므로, `갱신 시점을 확실히 검토해야한다`


